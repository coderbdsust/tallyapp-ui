<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Storage Cloud</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg:#ffffff; --surface:#f8f9fc; --card:#ffffff;
    --border:#e4e7ef; --accent:#16a36a; --accent2:#5b6af0;
    --accent3:#e0579a; --muted:#b0b8d0; --text:#1a1d2e; --dim:#8890a8;
    --tree-indent: 14px;
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
  body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;min-height:100vh;}
  h1,h2,h3,.syne{font-family:'Syne',sans-serif;}
  ::-webkit-scrollbar{width:4px;height:4px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:var(--muted);border-radius:4px;}

  /* â”€â”€ SIDEBAR â”€â”€ */
  #sidebar{position:fixed;left:0;top:0;bottom:0;width:252px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:50;}
  .nav-item{display:flex;align-items:center;gap:9px;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:12px;color:var(--dim);transition:all .15s;letter-spacing:.02em;}
  .nav-item:hover{background:var(--border);color:var(--text);}
  .nav-item.active{background:rgba(22,163,106,.1);color:var(--accent);}

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DIRECTIONAL FOLDER TREE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #folder-nav{outline:none;} /* focusable for keyboard nav */

  .tree-root{padding:2px 0 8px 0;}

  .tree-node{}

  .tree-row{
    display:flex;
    align-items:center;
    height:28px;
    border-radius:6px;
    cursor:pointer;
    color:var(--dim);
    transition:background .1s, color .1s, box-shadow .1s;
    white-space:nowrap;
    min-width:0;
    user-select:none;
    position:relative;
    margin:1px 4px 1px 0;
  }
  .tree-row:hover{background:rgba(0,0,0,.045);color:var(--text);}
  .tree-row.active{
    background:rgba(22,163,106,.1);
    color:var(--accent);
    font-weight:500;
  }
  .tree-row.focused{
    box-shadow:inset 0 0 0 1.5px var(--accent2);
    background:rgba(91,106,240,.06);
    color:var(--text);
    outline:none;
  }
  .tree-row.active.focused{
    box-shadow:inset 0 0 0 1.5px var(--accent);
    background:rgba(22,163,106,.14);
  }

  /* indentation guide lines */
  .tree-children{position:relative;}
  .tree-guide{
    position:absolute;
    left:0;
    top:0;
    bottom:2px;
    width:1px;
    background:var(--border);
    pointer-events:none;
    transition:opacity .2s;
  }
  .tree-row:hover ~ .tree-children > .tree-guide,
  .tree-row.active ~ .tree-children > .tree-guide{
    background:rgba(22,163,106,.3);
  }

  /* indent spacer */
  .tree-indent-block{
    flex-shrink:0;
    display:flex;
    align-items:center;
    height:100%;
  }
  .tree-indent-segment{
    width:var(--tree-indent);
    height:100%;
    flex-shrink:0;
    position:relative;
  }

  /* chevron toggle arrow */
  .tree-toggle{
    width:18px;
    height:28px;
    flex-shrink:0;
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--muted);
    transition:transform .18s cubic-bezier(.4,0,.2,1), color .1s, opacity .1s;
    border-radius:4px;
  }
  .tree-toggle svg{display:block;transition:transform .18s cubic-bezier(.4,0,.2,1);}
  .tree-toggle:hover{color:var(--text);background:rgba(0,0,0,.07);}
  .tree-toggle.open svg{transform:rotate(90deg);}
  .tree-toggle.empty{opacity:0;pointer-events:none;}
  .tree-row.active .tree-toggle{color:var(--accent);}

  /* folder icon */
  .tree-icon{font-size:13px;flex-shrink:0;width:20px;text-align:center;line-height:1;}

  /* label */
  .tree-label{
    flex:1;
    overflow:hidden;
    text-overflow:ellipsis;
    font-size:11.5px;
    line-height:1;
    padding:0 4px 0 2px;
    letter-spacing:.01em;
  }
  .tree-label.root-label{font-weight:700;font-size:12px;color:var(--text);}

  /* badge: file count */
  .tree-badge{
    font-size:9.5px;
    color:var(--muted);
    flex-shrink:0;
    background:var(--border);
    padding:1px 5px;
    border-radius:8px;
    margin-right:8px;
    letter-spacing:.03em;
    line-height:1.5;
  }
  .tree-row.active .tree-badge{
    background:rgba(22,163,106,.15);
    color:var(--accent);
  }

  /* loading spinner inline */
  @keyframes spin2{to{transform:rotate(360deg)}}
  .tree-spinning{animation:spin2 .7s linear infinite;display:inline-block;}

  /* â”€â”€ Keyboard nav indicator (focus ring visible only on keyboard) â”€â”€ */
  #folder-nav:focus-visible .tree-row.focused{
    box-shadow:inset 0 0 0 1.5px var(--accent2);
  }

  /* â”€â”€ arrow key direction hints (when a row is focused) â”€â”€ */
  .dir-hint{
    position:fixed;
    bottom:70px;
    left:12px;
    width:228px;
    background:rgba(26,29,46,.92);
    color:rgba(255,255,255,.85);
    border-radius:8px;
    padding:7px 10px;
    font-size:10px;
    display:none;
    gap:8px;
    flex-wrap:wrap;
    z-index:60;
    letter-spacing:.03em;
    backdrop-filter:blur(8px);
  }
  .dir-hint.show{display:flex;}
  .dir-key{
    display:inline-flex;align-items:center;justify-content:center;
    width:18px;height:18px;border-radius:4px;
    background:rgba(255,255,255,.15);
    font-size:10px;flex-shrink:0;
  }
  .dir-hint-item{display:flex;align-items:center;gap:4px;color:rgba(255,255,255,.7);}

  /* â”€â”€ Tree animations â”€â”€ */
  .tree-children-wrap{overflow:hidden;}
  @keyframes slideDown{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
  .tree-children-inner{animation:slideDown .18s ease both;}

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     EVERYTHING BELOW IS UNCHANGED FROM ORIGINAL
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #main{margin-left:252px;min-height:100vh;transition:margin-right .3s ease;}
  #main.hist-open{margin-right:280px;}
  #topbar{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.92);backdrop-filter:blur(14px);border-bottom:1px solid var(--border);padding:11px 24px;display:flex;align-items:center;gap:10px;}
  .crumb{font-size:12px;color:var(--dim);cursor:pointer;transition:color .15s;}
  .crumb:hover{color:var(--accent);}
  .crumb.leaf{color:var(--text);cursor:default;}
  .crumb-sep{color:var(--border);margin:0 5px;font-size:12px;}
  .inp{background:var(--card);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:12px;padding:7px 12px;border-radius:8px;outline:none;transition:border-color .15s;box-shadow:0 1px 3px rgba(0,0,0,.04);}
  .inp:focus{border-color:var(--accent);}
  .inp::placeholder{color:var(--muted);}
  .btn{display:inline-flex;align-items:center;gap:5px;cursor:pointer;border:none;transition:all .15s;font-family:'DM Mono',monospace;border-radius:8px;}
  .btn-p{background:var(--accent);color:#fff;font-family:'Syne',sans-serif;font-weight:700;padding:7px 16px;font-size:12px;letter-spacing:.03em;}
  .btn-p:hover{background:#13905d;box-shadow:0 4px 16px rgba(22,163,106,.25);}
  .btn-g{background:transparent;color:var(--dim);border:1px solid var(--border);padding:6px 12px;font-size:11px;}
  .btn-g:hover{border-color:var(--muted);color:var(--text);background:var(--surface);}
  .btn-i{background:var(--card);border:1px solid var(--border);color:var(--dim);padding:6px;box-shadow:0 1px 3px rgba(0,0,0,.04);}
  .btn-i:hover{color:var(--text);border-color:var(--muted);}
  .btn-i.on{background:rgba(22,163,106,.08);color:var(--accent);border-color:rgba(22,163,106,.3);}
  .tag{display:inline-flex;align-items:center;gap:3px;font-size:10px;letter-spacing:.07em;text-transform:uppercase;padding:2px 7px;border-radius:4px;}
  .stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 18px;box-shadow:0 1px 4px rgba(0,0,0,.05);}
  /* â”€â”€ Size toggle buttons â”€â”€ */
  .size-btn{
    font-family:'DM Mono',monospace;font-size:10px;font-weight:500;
    padding:4px 9px;border-radius:6px;border:none;cursor:pointer;
    color:var(--dim);background:transparent;transition:all .15s;
    letter-spacing:.05em;
  }
  .size-btn:hover{color:var(--text);background:var(--border);}
  .size-btn.active{background:var(--card);color:var(--accent);box-shadow:0 1px 4px rgba(0,0,0,.08);font-weight:700;}

  /* â”€â”€ BASE card styles â”€â”€ */
  .folder-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:10px;box-shadow:0 1px 4px rgba(0,0,0,.05);}
  .folder-card:hover{border-color:var(--muted);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.1);}
  .img-card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:pointer;transition:all .2s;position:relative;box-shadow:0 1px 4px rgba(0,0,0,.05);}
  .img-card:hover{border-color:var(--muted);transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,0,0,.12);}
  .img-card:hover .img-ov{opacity:1;}
  .img-thumb{width:100%;aspect-ratio:16/10;object-fit:cover;display:block;background:var(--border);}
  .img-ph{width:100%;aspect-ratio:16/10;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#f0f4ff,#e8f0fe);font-size:28px;}
  .img-ov{position:absolute;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;gap:8px;opacity:0;transition:opacity .2s;}
  .img-meta{padding:9px 11px;}
  .file-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;gap:8px;box-shadow:0 1px 4px rgba(0,0,0,.05);}
  .file-card:hover{border-color:var(--muted);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.08);}

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SIZE VARIANTS
     Applied as data-size="xs|sm|md|lg" on #grid-view
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* â”€â”€ XS: ultra-dense, tiny thumbnails â”€â”€ */
  #grid-view[data-size="xs"] .img-thumb,
  #grid-view[data-size="xs"] .img-ph { aspect-ratio:3/2; font-size:16px; }
  #grid-view[data-size="xs"] .img-ph { font-size:16px; }
  #grid-view[data-size="xs"] .img-meta { padding:5px 7px; }
  #grid-view[data-size="xs"] .img-meta p:first-child { font-size:9.5px; }
  #grid-view[data-size="xs"] .img-meta p:last-child  { font-size:9px; }
  #grid-view[data-size="xs"] .img-ov .btn-g          { font-size:9px; padding:3px 6px; }
  #grid-view[data-size="xs"] .folder-card            { padding:8px 10px; gap:7px; border-radius:8px; }
  #grid-view[data-size="xs"] .folder-card .syne      { font-size:11px; }
  #grid-view[data-size="xs"] .folder-card p:last-child{ font-size:9.5px; }
  #grid-view[data-size="xs"] .folder-card > div:first-child { width:28px;height:28px;font-size:14px; }
  #grid-view[data-size="xs"] .file-card              { padding:8px 10px; gap:5px; border-radius:8px; }
  #grid-view[data-size="xs"] .file-card > div:first-child { font-size:20px; }
  #grid-view[data-size="xs"] .file-card > p          { font-size:9.5px; }
  #grid-view[data-size="xs"] .file-card .tag         { font-size:8.5px; padding:1px 5px; }
  #grid-view[data-size="xs"] .img-card               { border-radius:8px; }

  /* â”€â”€ SM: compact â”€â”€ */
  #grid-view[data-size="sm"] .img-thumb,
  #grid-view[data-size="sm"] .img-ph { aspect-ratio:4/3; }
  #grid-view[data-size="sm"] .img-ph { font-size:22px; }
  #grid-view[data-size="sm"] .img-meta { padding:7px 9px; }
  #grid-view[data-size="sm"] .img-meta p:first-child { font-size:10.5px; }
  #grid-view[data-size="sm"] .img-meta p:last-child  { font-size:9.5px; }
  #grid-view[data-size="sm"] .folder-card            { padding:10px 12px; gap:8px; }
  #grid-view[data-size="sm"] .folder-card .syne      { font-size:12px; }
  #grid-view[data-size="sm"] .folder-card > div:first-child { width:32px;height:32px;font-size:16px; }
  #grid-view[data-size="sm"] .file-card              { padding:10px 12px; gap:6px; }
  #grid-view[data-size="sm"] .file-card > div:first-child { font-size:26px; }
  #grid-view[data-size="sm"] .file-card > p          { font-size:11px; }

  /* â”€â”€ MD: default (no overrides needed, base styles apply) â”€â”€ */

  /* â”€â”€ LG: spacious, tall thumbnails â”€â”€ */
  #grid-view[data-size="lg"] .img-thumb,
  #grid-view[data-size="lg"] .img-ph { aspect-ratio:4/3; font-size:48px; }
  #grid-view[data-size="lg"] .img-ph { font-size:48px; }
  #grid-view[data-size="lg"] .img-meta { padding:13px 15px; }
  #grid-view[data-size="lg"] .img-meta p:first-child { font-size:13px; }
  #grid-view[data-size="lg"] .img-meta p:last-child  { font-size:11px; }
  #grid-view[data-size="lg"] .img-ov .btn-g          { font-size:12px; padding:8px 14px; }
  #grid-view[data-size="lg"] .folder-card            { padding:18px 20px; gap:14px; border-radius:14px; }
  #grid-view[data-size="lg"] .folder-card .syne      { font-size:15px; }
  #grid-view[data-size="lg"] .folder-card p:last-child{ font-size:12px; }
  #grid-view[data-size="lg"] .folder-card > div:first-child { width:52px;height:52px;font-size:26px; }
  #grid-view[data-size="lg"] .file-card              { padding:20px; gap:12px; border-radius:14px; }
  #grid-view[data-size="lg"] .file-card > div:first-child { font-size:44px; }
  #grid-view[data-size="lg"] .file-card > p          { font-size:13px; }
  #grid-view[data-size="lg"] .file-card .tag         { font-size:11px; padding:3px 9px; }
  #grid-view[data-size="lg"] .img-card               { border-radius:16px; }
  #list-view{display:none;padding:20px 24px;}
  .ltable{width:100%;border-collapse:collapse;}
  .ltable thead th{font-size:10px;letter-spacing:.09em;text-transform:uppercase;color:var(--dim);padding:8px 12px;border-bottom:1px solid var(--border);text-align:left;font-weight:400;}
  .ltable tbody tr{cursor:pointer;transition:background .1s;}
  .ltable tbody tr:hover td{background:var(--surface);}
  .ltable tbody td{padding:10px 12px;font-size:12px;border-bottom:1px solid rgba(228,231,239,.6);}
  #history-view{display:none;padding:20px 24px;}
  .hist-row{display:flex;align-items:center;gap:12px;padding:11px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;}
  .hist-row:hover{background:var(--surface);}
  .hist-th{width:42px;height:42px;border-radius:8px;flex-shrink:0;overflow:hidden;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:18px;}
  #hist-panel{position:fixed;right:0;top:0;bottom:0;width:280px;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;z-index:50;transform:translateX(100%);transition:transform .3s ease;}
  #hist-panel.open{transform:translateX(0);}
  .hpanel-row{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s;}
  .hpanel-row:hover{background:var(--card);}
  #lb{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px);}
  #lb.open{display:flex;}
  #lb img{max-width:90vw;max-height:88vh;border-radius:8px;box-shadow:0 24px 80px rgba(0,0,0,.5);transition:opacity .15s;}
  #lb-close{position:absolute;top:18px;right:22px;background:rgba(255,255,255,.15);border:none;color:#fff;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:background .15s;}
  #lb-close:hover{background:rgba(255,255,255,.25);}
  .lb-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:#fff;width:44px;height:44px;border-radius:50%;cursor:pointer;font-size:22px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
  .lb-nav:hover{background:rgba(255,255,255,.22);}
  #lb-prev{left:18px;} #lb-next{right:18px;}
  #lb-cap{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);font-size:12px;color:rgba(255,255,255,.75);background:rgba(0,0,0,.45);padding:5px 16px;border-radius:20px;white-space:nowrap;max-width:80vw;overflow:hidden;text-overflow:ellipsis;}
  .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
  .empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;gap:12px;color:var(--dim);}
  .prog-bar{height:3px;background:var(--border);border-radius:2px;overflow:hidden;}
  .prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:2px;transition:width .4s ease;}
  #toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--text);border:1px solid rgba(0,0,0,.1);color:#fff;padding:10px 20px;border-radius:10px;font-size:12px;z-index:300;transition:transform .3s ease;white-space:nowrap;box-shadow:0 8px 32px rgba(0,0,0,.15);}
  #toast.show{transform:translateX(-50%) translateY(0);}
  @keyframes fu{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .fu{animation:fu .35s cubic-bezier(.4,0,.2,1) both;}
  #grid-view{display:none;padding:20px 24px;gap:12px;}
  #drop-overlay{position:fixed;inset:0;background:rgba(22,163,106,0.3);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:9999;pointer-events:none;}
  #drop-overlay.active{display:flex;}
  #drop-overlay span{font-size:3.5rem;font-weight:800;color:white;text-shadow:0 4px 16px rgba(0,0,0,0.6);font-family:'Syne',sans-serif;}
</style>
</head>
<body>

<aside id="sidebar">
  <div style="padding:16px;border-bottom:1px solid var(--border);">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;">
      <div style="width:30px;height:30px;background:var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
      </div>
      <span class="syne" style="font-weight:800;font-size:14px;color:var(--text)">Storage Cloud</span>
    </div>
    <div style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:inset 0 1px 3px rgba(0,0,0,.03);">
      <p style="font-size:10px;letter-spacing:.09em;text-transform:uppercase;color:var(--dim);">Nginx URL</p>
      <input id="server-url" class="inp" style="width:100%;" placeholder="http://your-server/files/"/>
      <button class="btn btn-p" style="width:100%;justify-content:center;" onclick="startScan()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.5"/></svg>
        Scan Directory
      </button>
    </div>
  </div>

  <nav style="padding:10px 8px;flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:1px;">
    <div class="nav-item active" id="nav-all" onclick="showSec('all')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/></svg>All Files
    </div>
    <div class="nav-item" id="nav-gallery" onclick="showSec('gallery')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Gallery
    </div>
    <div class="nav-item" id="nav-history" onclick="showSec('history')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>History
    </div>
    <div style="height:1px;background:var(--border);margin:8px 6px;"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;padding:2px 8px;margin-bottom:2px;">
      <p style="font-size:10px;letter-spacing:.09em;text-transform:uppercase;color:var(--dim);">Folders</p>
      <span style="font-size:9.5px;color:var(--muted);letter-spacing:.04em;">â†‘â†“â†â†’ keys</span>
    </div>
    <!-- TREE: tabindex makes it focusable for keyboard nav -->
    <div id="folder-nav" tabindex="0" style="flex:1;outline:none;"></div>
  </nav>

  <div style="padding:10px 14px;border-top:1px solid var(--border);background:var(--surface);">
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--dim);margin-bottom:4px;">
      <span id="scan-status">Not scanned</span>
      <span id="scan-pct">0%</span>
    </div>
    <div class="prog-bar"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
  </div>
</aside>

<!-- Keyboard direction hint overlay -->
<div class="dir-hint" id="dir-hint">
  <div class="dir-hint-item"><span class="dir-key">â†‘</span> Prev</div>
  <div class="dir-hint-item"><span class="dir-key">â†“</span> Next</div>
  <div class="dir-hint-item"><span class="dir-key">â†’</span> Expand</div>
  <div class="dir-hint-item"><span class="dir-key">â†</span> Collapse</div>
  <div class="dir-hint-item"><span class="dir-key">â†µ</span> Open</div>
  <div class="dir-hint-item"><span class="dir-key">Esc</span> Up</div>
</div>

<div id="main">
  <div id="topbar">
    <div id="bc" style="display:flex;align-items:center;flex-wrap:wrap;gap:2px;"></div>
    <div style="flex:1;"></div>
    <div style="position:relative;">
      <svg style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input class="inp" id="q" placeholder="Search filesâ€¦" style="padding-left:32px;width:280px;" oninput="renderCurrent()"/>
    </div>
    <select id="type-filter" onchange="renderCurrent()" style="background:var(--card);border:1px solid var(--border);color:var(--dim);font-family:'DM Mono',monospace;font-size:11px;padding:6px 8px;border-radius:7px;outline:none;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.04);">
      <option value="">All types</option>
      <option value="image">Images</option>
      <option value="video">Videos</option>
      <option value="file">Other</option>
    </select>
    <div id="size-btns" style="display:flex;gap:2px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:2px;box-shadow:0 1px 3px rgba(0,0,0,.04);">
      <button onclick="setSize('xs')" data-size="xs" class="size-btn active" title="Extra Small â€” dense grid">XS</button>
      <button onclick="setSize('sm')" data-size="sm" class="size-btn" title="Small">S</button>
      <button onclick="setSize('md')" data-size="md" class="size-btn" title="Medium">M</button>
      <button onclick="setSize('lg')" data-size="lg" class="size-btn" title="Large â€” big cards">L</button>
    </div>
    <button class="btn btn-i on" id="btn-grid" onclick="setView('grid')" title="Grid">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
    </button>
    <button class="btn btn-i" id="btn-list" onclick="setView('list')" title="List">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/></svg>
    </button>
    <button class="btn btn-g" onclick="toggleHistPanel()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      History
    </button>
  </div>

  <div id="stats-bar" style="display:none;padding:16px 24px 0;">
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:4px;">
      <div class="stat-card fu"><p style="font-size:10px;text-transform:uppercase;letter-spacing:.09em;color:var(--dim);margin-bottom:4px;">Files</p><p class="syne" style="font-size:22px;font-weight:700;color:var(--accent);" id="s-total">0</p></div>
      <div class="stat-card fu"><p style="font-size:10px;text-transform:uppercase;letter-spacing:.09em;color:var(--dim);margin-bottom:4px;">Images</p><p class="syne" style="font-size:22px;font-weight:700;color:var(--accent2);" id="s-img">0</p></div>
      <div class="stat-card fu"><p style="font-size:10px;text-transform:uppercase;letter-spacing:.09em;color:var(--dim);margin-bottom:4px;">Videos</p><p class="syne" style="font-size:22px;font-weight:700;color:var(--accent3);" id="s-vid">0</p></div>
      <div class="stat-card fu"><p style="font-size:10px;text-transform:uppercase;letter-spacing:.09em;color:var(--dim);margin-bottom:4px;">Folders</p><p class="syne" style="font-size:22px;font-weight:700;color:#f59e0b;" id="s-fold">0</p></div>
      <div class="stat-card fu"><p style="font-size:10px;text-transform:uppercase;letter-spacing:.09em;color:var(--dim);margin-bottom:4px;">Size</p><p class="syne" style="font-size:22px;font-weight:700;color:var(--text);" id="s-size">â€”</p></div>
    </div>
  </div>

  <div id="content">
    <div id="welcome" class="empty">
      <div style="font-size:52px;opacity:.5;">ğŸŒ©ï¸</div>
      <p class="syne" style="font-size:18px;font-weight:700;color:var(--text);">Connect to your nginx server</p>
      <p style="font-size:12px;color:var(--dim);text-align:center;max-width:340px;">Enter the URL of your nginx directory listing and hit <strong style="color:var(--accent)">Scan Directory</strong>.</p>
    </div>
    <div id="loading" class="empty" style="display:none;">
      <div class="spinner"></div>
      <p style="font-size:13px;color:var(--dim);" id="load-msg">Scanningâ€¦</p>
    </div>
    <div id="grid-view"></div>
    <div id="list-view">
      <table class="ltable">
        <thead><tr><th>Name</th><th>Folder</th><th>Type</th><th>Size</th><th>Modified</th></tr></thead>
        <tbody id="list-body"></tbody>
      </table>
    </div>
    <div id="history-view">
      <h2 class="syne" style="font-size:13px;font-weight:700;letter-spacing:.06em;margin-bottom:16px;color:var(--text);">BROWSE HISTORY</h2>
      <div id="hv-list" style="background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.05);"></div>
    </div>
  </div>
</div>

<div id="drop-overlay"><span>Drop files to upload</span></div>

<div id="hist-panel">
  <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
    <span class="syne" style="font-size:13px;font-weight:700;">Recent Activity</span>
    <button class="btn btn-i" style="padding:4px;" onclick="toggleHistPanel()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div id="hp-list" style="flex:1;overflow-y:auto;"></div>
</div>

<div id="lb">
  <button id="lb-close" onclick="lbClose()">âœ•</button>
  <button class="lb-nav" id="lb-prev" onclick="lbNav(-1)">â€¹</button>
  <img id="lb-img" src="" alt=""/>
  <button class="lb-nav" id="lb-next" onclick="lbNav(1)">â€º</button>
  <div id="lb-cap"></div>
</div>
<div id="toast"></div>

<script>
// ============================================================================
// CONFIG & CONSTANTS
// ============================================================================
const IMG_EXTS = new Set(['jpg','jpeg','png','gif','webp','bmp','tiff','tif','svg','avif','heic','ico']);
const VID_EXTS = new Set(['mp4','webm','mov','avi','mkv','ogv','m4v']);
const MAX_HIST  = 300;

// ============================================================================
// STATE
// ============================================================================
let BASE_URL       = '';
let ROOT           = null;
let LB_IMGS        = [];
let LB_IDX         = 0;
let VIEW           = 'grid';
let SEC            = 'all';
let CURRENT_NODE   = null;
let HIST           = [];
let SCANNING       = false;
let dragCounter    = 0;

// ============================================================================
// TREE NODE
// ============================================================================
function makeFolder(name, url) {
  return { type:'folder', name, url, children:[], loaded:false };
}

function makeFile(name, url, size, mtime) {
  const ext  = (name.split('.').pop() || '').toLowerCase();
  const kind = IMG_EXTS.has(ext) ? 'image' : VID_EXTS.has(ext) ? 'video' : 'file';
  return { type:'file', name, url, ext, kind, size: size||null, mtime: mtime||null };
}

// ============================================================================
// FETCH A SINGLE DIRECTORY
// ============================================================================
async function fetchDir(folderUrl) {
  const res = await fetch(folderUrl, { headers:{ Accept:'application/json' } });
  if (!res.ok) throw new Error(`HTTP ${res.status} for ${folderUrl}`);

  const ct = res.headers.get('content-type') || '';
  if (ct.includes('json')) {
    return await res.json();
  }

  const html = await res.text();
  const doc  = new DOMParser().parseFromString(html, 'text/html');
  return [...doc.querySelectorAll('a[href]')].map(a => {
    const h = a.getAttribute('href');
    if (!h || h === '../' || h === '/' || h.startsWith('?')) return null;
    const isDir = h.endsWith('/');
    return { name: decodeURIComponent(h.replace(/\/$/, '')), type: isDir ? 'directory' : 'file' };
  }).filter(Boolean);
}

// ============================================================================
// LOAD A NODE'S CHILDREN
// ============================================================================
async function loadNode(node) {
  if (node.loaded) return;

  prog(null, `Loading ${node.name || 'root'}â€¦`);
  const entries = await fetchDir(node.url);

  node.children = [];

  for (const e of entries) {
    const name  = e.name || (e.name = String(e.name || '').replace(/\/$/, ''));
    const rawName = String(name).replace(/\/$/, '');
    if (!rawName || rawName === '..') continue;

    const isDir = e.type === 'directory' || String(e.name||'').endsWith('/');
    if (isDir) {
      const childUrl = node.url + encodeURIComponent(rawName) + '/';
      node.children.push(makeFolder(rawName, childUrl));
    } else {
      const fileUrl = node.url + encodeURIComponent(rawName);
      node.children.push(makeFile(rawName, fileUrl, e.size, e.mtime));
    }
  }

  node.loaded = true;
}

// ============================================================================
// FIND NODE BY PATH SEGMENTS
// ============================================================================
function findNodeBySegments(segments) {
  let cur = ROOT;
  for (const seg of segments) {
    if (!seg) continue;
    const child = cur.children.find(c => c.type === 'folder' && c.name === seg);
    if (!child) return null;
    cur = child;
  }
  return cur;
}

function expandAncestors(targetNode) {
  const path = getNodePath(targetNode);
  const segs = path.split('/').filter(Boolean);
  let cur = ROOT;
  EXPANDED.add(cur);
  for (const seg of segs) {
    const child = cur.children.find(c => c.type === 'folder' && c.name === seg);
    if (!child) break;
    EXPANDED.add(child);
    cur = child;
  }
}

// ============================================================================
// START SCAN
// ============================================================================
async function startScan() {
  if (SCANNING) return;
  const rawUrl = document.getElementById('server-url').value.trim();
  if (!rawUrl) { toast('âš  Enter a URL'); return; }

  BASE_URL = rawUrl.replace(/\/?$/, '/');

  SCANNING     = true;
  CURRENT_NODE = null;
  ROOT         = makeFolder('Root', BASE_URL);
  LB_IMGS      = [];
  TREE_FLAT    = [];
  FOCUSED_NODE = null;

  showLoad('Connectingâ€¦');
  prog(0, 'Loading rootâ€¦');
  document.getElementById('stats-bar').style.display = 'none';

  try {
    await loadNode(ROOT);
    prog(100, `Root loaded â€” ${ROOT.children.length} items`);
    addHist({ type:'scan', url:BASE_URL, ts:Date.now() });
    saveHist(); renderHistPanel(); renderHistView();
    updateStats(); renderFolderNav();
    document.getElementById('stats-bar').style.display = 'block';
    const hashPath = readHash();
    if (hashPath) {
      await drillByPath(hashPath);
    } else {
      renderCurrent();
    }
    toast(`âœ“ Root loaded â€” ${ROOT.children.length} items`);
  } catch (err) {
    console.error(err);
    showWelcome();
    toast('âœ— Connection failed â€” check URL & CORS');
    prog(0, 'Failed');
  } finally {
    SCANNING = false;
  }
}

// ============================================================================
// DRILL INTO A FOLDER NODE
// ============================================================================
async function drillFolder(node) {
  if (!node) { goRoot(); return; }

  CURRENT_NODE = node;
  pushHash(getNodePath(node));
  setBreadcrumbs(node);
  addHist({ type:'folder', folder:getNodePath(node), name:node.name, ts:Date.now() });
  saveHist(); renderHistPanel();

  expandAncestors(node);

  if (!node.loaded) {
    showLoad(`Loading ${node.name}â€¦`);
    try {
      await loadNode(node);
    } catch(err) {
      console.error(err);
      toast(`âœ— Could not load ${node.name}`);
    }
  }

  updateStats();
  renderFolderNav();
  renderCurrent();
}

// ============================================================================
// DRILL BY PATH STRING
// ============================================================================
async function drillByPath(pathStr) {
  const segs = pathStr.split('/').filter(Boolean);
  let cur = ROOT;

  for (let i = 0; i < segs.length; i++) {
    if (!cur.loaded) await loadNode(cur);
    const next = cur.children.find(c => c.type === 'folder' && c.name === segs[i]);
    if (!next) { toast(`Folder "${segs[i]}" not found`); break; }
    cur = next;
  }

  CURRENT_NODE = cur === ROOT ? null : cur;
  if (CURRENT_NODE) {
    if (!CURRENT_NODE.loaded) {
      showLoad(`Loading ${CURRENT_NODE.name}â€¦`);
      await loadNode(CURRENT_NODE);
    }
    setBreadcrumbs(CURRENT_NODE);
  } else {
    bc([{ l:'Root' }]);
  }

  updateStats(); renderFolderNav(); renderCurrent();
}

// ============================================================================
// GO TO ROOT
// ============================================================================
function goRoot() {
  CURRENT_NODE = null;
  pushHash(null);
  bc([{ l: SEC === 'gallery' ? 'Gallery' : 'All Files' }]);
  renderCurrent();
}

// ============================================================================
// GET PATH STRING FROM NODE
// ============================================================================
function getNodePath(node) {
  if (!node || node === ROOT) return '';
  return node.url.replace(BASE_URL, '').replace(/\/$/, '');
}

// ============================================================================
// SET BREADCRUMBS FOR A NODE
// ============================================================================
function setBreadcrumbs(node) {
  if (!node) { bc([{ l: SEC === 'gallery' ? 'Gallery' : 'All Files' }]); return; }
  const path = getNodePath(node);
  const segs = path.split('/').filter(Boolean);
  const crumbs = [{ l:'Root', action:'goRoot()' }];

  let cur = ROOT;
  for (let i = 0; i < segs.length; i++) {
    const child = cur.children.find(c => c.type === 'folder' && c.name === segs[i]);
    if (!child) break;
    if (i === segs.length - 1) {
      crumbs.push({ l: segs[i] });
    } else {
      crumbs.push({ l: segs[i], action:`drillFolder(findNodeBySegments(${JSON.stringify(segs.slice(0,i+1))}))` });
    }
    cur = child;
  }
  bc(crumbs);
}

// ============================================================================
// RENDER CURRENT VIEW
// ============================================================================
function renderCurrent() {
  if (SEC === 'history') { renderHistView(); return; }

  const node = CURRENT_NODE || ROOT;
  if (!node) { showWelcome(); return; }

  const q  = document.getElementById('q').value.toLowerCase().trim();
  const tf = document.getElementById('type-filter').value;

  let items = [...node.children];

  if (q)  items = items.filter(it => it.name.toLowerCase().includes(q));
  if (tf === 'image') items = items.filter(it => it.kind === 'image');
  if (tf === 'video') items = items.filter(it => it.kind === 'video');
  if (tf === 'file')  items = items.filter(it => it.type === 'file' && it.kind === 'file');
  if (SEC === 'gallery') items = items.filter(it => it.kind === 'image');

  LB_IMGS = items.filter(it => it.kind === 'image');

  hideAll();
  if (VIEW === 'grid') renderGrid(items);
  else renderList(items);
}

// ============================================================================
// RENDER GRID
// ============================================================================
// â”€â”€ Size configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SIZE_CONFIG = {
  xs: { cols: 8, gap: 6  },
  sm: { cols: 5, gap: 10 },
  md: { cols: 4, gap: 12 },
  lg: { cols: 2, gap: 16 },
};
let CURRENT_SIZE = 'xs';

function setSize(sz) {
  CURRENT_SIZE = sz;
  document.querySelectorAll('.size-btn').forEach(b => b.classList.toggle('active', b.dataset.size === sz));
  renderCurrent();
}

function renderGrid(items) {
  const { cols, gap } = SIZE_CONFIG[CURRENT_SIZE] || SIZE_CONFIG.md;
  const gv = document.getElementById('grid-view');
  gv.dataset.size = CURRENT_SIZE;
  gv.style.cssText = `display:grid;grid-template-columns:repeat(${cols},1fr);gap:${gap}px;padding:20px 24px;`;

  if (!items.length) {
    gv.innerHTML = `<div class="empty" style="grid-column:1/-1">
      <div style="font-size:40px;opacity:.4;">${CURRENT_NODE ? 'ğŸ“‚' : 'ğŸ”'}</div>
      <p style="color:var(--dim)">${CURRENT_NODE ? 'Empty folder' : 'No files'}</p>
    </div>`;
    return;
  }

  gv.innerHTML = items.map((it, i) => {
    const delay = Math.min(i * 0.03, 0.6) + 's';
    if (it.type === 'folder') {
      return `<div class="folder-card fu" style="animation-delay:${delay}" onclick="handleFolderClick(this)" data-folder-name="${esc(it.name)}">
        <div style="width:40px;height:40px;background:rgba(251,191,36,.1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">ğŸ“</div>
        <div style="flex:1;min-width:0;">
          <p class="syne" style="font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${esc(it.name)}">${esc(it.name)}</p>
          <p style="font-size:11px;color:var(--dim);">${it.children.length} item${it.children.length !== 1 ? 's' : ''}${it.loaded ? '' : ' Â· click to load'}</p>
        </div>
      </div>`;
    }
    return renderFileCard(it, delay);
  }).join('');
}

function handleFolderClick(el) {
  const name = el.dataset.folderName;
  const parent = CURRENT_NODE || ROOT;
  const node = parent.children.find(c => c.type === 'folder' && c.name === name);
  if (node) drillFolder(node);
}

function renderFileCard(f, delay) {
  if (f.kind === 'image') {
    const idx = LB_IMGS.indexOf(f);
    return `<div class="img-card fu" style="animation-delay:${delay}" onclick="lbOpen(${idx})">
      <img class="img-thumb" src="${esc(f.url)}" loading="lazy" alt="${esc(f.name)}"
        onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"/>
      <div class="img-ph" style="display:none">ğŸ–¼ï¸</div>
      <div class="img-ov">
        <span class="btn btn-g" style="color:#fff;border-color:rgba(255,255,255,.4);">ğŸ‘ View</span>
        <a href="${esc(f.url)}" download class="btn btn-g" style="color:#fff;border-color:rgba(255,255,255,.4);" onclick="event.stopPropagation()">â¬‡ Save</a>
      </div>
      <div class="img-meta">
        <p style="font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${esc(f.name)}">${esc(f.name)}</p>
        <p style="font-size:10px;color:var(--dim);">${f.ext.toUpperCase()}${f.size ? ' Â· '+fmtSz(f.size) : ''}</p>
      </div>
    </div>`;
  }

  if (f.kind === 'video') {
    return `<div class="img-card fu" style="animation-delay:${delay}" onclick="window.open('${esc(f.url)}','_blank')">
      <div class="img-ph" style="background:linear-gradient(135deg,#f0e8ff,#e8f0fe)">ğŸ¬</div>
      <div class="img-meta">
        <p style="font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(f.name)}</p>
        <p style="font-size:10px;color:var(--dim);">${f.ext.toUpperCase()}${f.size ? ' Â· '+fmtSz(f.size) : ''}</p>
      </div>
    </div>`;
  }

  const [icon, color] = fileStyle(f.ext);
  return `<div class="file-card fu" style="animation-delay:${delay}" onclick="window.open('${esc(f.url)}','_blank')">
    <div style="font-size:32px;">${icon}</div>
    <p style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${esc(f.name)}">${esc(f.name)}</p>
    <div style="display:flex;justify-content:space-between;">
      <span class="tag" style="background:${color}22;color:${color}">${f.ext.toUpperCase()}</span>
      ${f.size ? `<span style="font-size:10px;color:var(--dim)">${fmtSz(f.size)}</span>` : ''}
    </div>
  </div>`;
}

// ============================================================================
// RENDER LIST
// ============================================================================
function renderList(items) {
  document.getElementById('list-view').style.display = 'block';
  const folderPath = CURRENT_NODE ? getNodePath(CURRENT_NODE) : '/';
  document.getElementById('list-body').innerHTML = items.map(it => {
    if (it.type === 'folder') {
      return `<tr onclick="handleFolderClickByName('${esc(it.name)}')">
        <td style="display:flex;align-items:center;gap:8px;"><span style="font-size:18px;">ğŸ“</span> ${esc(it.name)}/</td>
        <td style="color:var(--dim);font-size:11px;">${esc(folderPath)}</td>
        <td><span class="tag" style="background:#fef3c7;color:#92400e;">FOLDER</span></td>
        <td style="color:var(--dim)">${it.children.length} items${it.loaded?'':' (unloaded)'}</td>
        <td style="color:var(--dim)">â€”</td>
      </tr>`;
    }
    const [icon, color] = fileStyle(it.ext);
    const typeIc = it.kind==='image'?'ğŸ–¼ï¸':it.kind==='video'?'ğŸ¬':icon;
    return `<tr onclick="${it.kind==='image'?`lbOpen(${LB_IMGS.indexOf(it)})`:`window.open('${esc(it.url)}','_blank')`}">
      <td style="display:flex;align-items:center;gap:8px;min-width:0;">
        <span style="font-size:16px;flex-shrink:0;">${typeIc}</span>
        <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px;" title="${esc(it.name)}">${esc(it.name)}</span>
      </td>
      <td style="color:var(--dim);font-size:11px;">${esc(folderPath)}</td>
      <td><span class="tag" style="background:${color}22;color:${color}">${it.ext.toUpperCase()}</span></td>
      <td style="color:var(--dim)">${it.size ? fmtSz(it.size) : 'â€”'}</td>
      <td style="color:var(--dim)">${it.mtime ? new Date(it.mtime).toLocaleDateString() : 'â€”'}</td>
    </tr>`;
  }).join('') || '<tr><td colspan="5" style="text-align:center;padding:60px;color:var(--dim);">Empty folder</td></tr>';
}

function handleFolderClickByName(name) {
  const parent = CURRENT_NODE || ROOT;
  const node = parent.children.find(c => c.type === 'folder' && c.name === name);
  if (node) drillFolder(node);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR FOLDER TREE â€” DIRECTIONAL NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const EXPANDED     = new WeakSet();
let   FOCUSED_NODE = null;   // which node has keyboard focus highlight
let   TREE_FLAT    = [];     // flat ordered list of visible nodes for up/down nav

// Build the flat visible list (depth-first, only expanded branches)
function buildFlatList(node, arr) {
  arr.push(node);
  if (EXPANDED.has(node)) {
    for (const child of node.children) {
      if (child.type === 'folder') buildFlatList(child, arr);
    }
  }
  return arr;
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFolderNav() {
  const container = document.getElementById('folder-nav');
  if (!ROOT) {
    container.innerHTML = '<div style="padding:8px 14px;color:var(--dim);font-size:11px;">Not scanned</div>';
    return;
  }
  EXPANDED.add(ROOT);
  TREE_FLAT = buildFlatList(ROOT, []);

  container.innerHTML = `<div class="tree-root">${renderTreeNode(ROOT, 0)}</div>`;
}

const CHEVRON_SVG = `<svg width="7" height="7" viewBox="0 0 8 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="2,1 6,4 2,7"/></svg>`;

function renderTreeNode(node, depth) {
  const isRoot     = node === ROOT;
  const isActive   = CURRENT_NODE === node || (isRoot && !CURRENT_NODE);
  const isFocused  = FOCUSED_NODE === node;
  const isExpanded = EXPANDED.has(node);
  const subFolders = node.children.filter(c => c.type === 'folder');
  const hasKids    = subFolders.length > 0 || !node.loaded;
  const fileCount  = node.children.filter(c => c.type === 'file').length;
  const path       = isRoot ? '' : getNodePath(node);

  // Icon: open folder if active or expanded
  const icon = isRoot ? 'ğŸ—„ï¸' : (isActive || isExpanded) ? 'ğŸ“‚' : 'ğŸ“';

  const toggleCls = !hasKids ? 'empty' : isExpanded ? 'open' : '';
  const rowCls = `tree-row${isActive ? ' active' : ''}${isFocused ? ' focused' : ''}`;

  const badge = (node.loaded && fileCount)
    ? `<span class="tree-badge">${fileCount}f</span>`
    : (!node.loaded && !isRoot)
    ? `<span class="tree-badge" style="opacity:.5;">â€¦</span>`
    : '';

  // Indent spacer: one segment per depth level, but root is at depth 0
  const indentPx = depth * 14;
  const indentStyle = depth > 0 ? `padding-left:${indentPx}px;` : '';

  let childrenHtml = '';
  if (isExpanded) {
    if (!node.loaded) {
      const childIndent = (depth + 1) * 14;
      childrenHtml = `<div class="tree-children" style="position:relative;">
        <div class="tree-guide" style="left:${depth * 14 + 10}px;"></div>
        <div style="height:26px;display:flex;align-items:center;padding-left:${childIndent + 18}px;font-size:11px;color:var(--muted);">
          <span class="tree-spinning">â†»</span>&nbsp;Loadingâ€¦
        </div>
      </div>`;
    } else if (subFolders.length) {
      childrenHtml = `<div class="tree-children" style="position:relative;">
        <div class="tree-guide" style="left:${depth * 14 + 10}px;"></div>
        <div class="tree-children-inner">
          ${subFolders.map(f => renderTreeNode(f, depth + 1)).join('')}
        </div>
      </div>`;
    }
  }

  const rowClick   = isRoot ? `onclick="goRoot()"` : `onclick="treeRowClick(event,'${esc(path)}')"`;
  const toggleEvt  = isRoot ? `onclick="treeToggleRoot(event)"` : `onclick="treeToggle(event,'${esc(path)}')"`;
  const labelStyle = isRoot ? 'class="tree-label root-label"' : 'class="tree-label"';

  return `<div class="tree-node">
    <div class="${rowCls}" style="${indentStyle}" ${rowClick}
         data-path="${esc(path)}"
         title="${esc(node.name)}">
      <span class="tree-toggle ${toggleCls}" ${toggleEvt}>${CHEVRON_SVG}</span>
      <span class="tree-icon">${icon}</span>
      <span ${labelStyle}>${esc(isRoot ? 'Root' : node.name)}</span>
      ${badge}
    </div>
    ${childrenHtml}
  </div>`;
}

// â”€â”€ TOGGLE ROOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function treeToggleRoot(event) {
  event.stopPropagation();
  if (EXPANDED.has(ROOT)) EXPANDED.delete(ROOT);
  else EXPANDED.add(ROOT);
  renderFolderNav();
}

// â”€â”€ ROW CLICK (navigate) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function treeRowClick(event, path) {
  if (event.target.closest('.tree-toggle')) return;
  FOCUSED_NODE = findNodeBySegments(path.split('/').filter(Boolean));
  drillByPath(path);
}

// â”€â”€ TOGGLE (expand/collapse only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function treeToggle(event, path) {
  event.stopPropagation();
  const segs = path.split('/').filter(Boolean);
  const node = findNodeBySegments(segs);
  if (!node) return;

  if (EXPANDED.has(node)) {
    EXPANDED.delete(node);
    renderFolderNav();
    return;
  }

  EXPANDED.add(node);

  if (!node.loaded) {
    renderFolderNav(); // show spinner
    try {
      await loadNode(node);
      updateStats();
    } catch(e) {
      console.error(e);
      toast(`âœ— Could not load ${node.name}`);
      EXPANDED.delete(node);
    }
  }
  renderFolderNav();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIRECTIONAL KEYBOARD NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let hintTimer = null;

function showDirHint() {
  const h = document.getElementById('dir-hint');
  h.classList.add('show');
  clearTimeout(hintTimer);
  hintTimer = setTimeout(() => h.classList.remove('show'), 2800);
}

function scrollFocusedIntoView() {
  const nav = document.getElementById('folder-nav');
  const focused = nav.querySelector('.tree-row.focused');
  if (focused) focused.scrollIntoView({ block:'nearest', behavior:'smooth' });
}

document.addEventListener('DOMContentLoaded', () => {
  const nav = document.getElementById('folder-nav');

  nav.addEventListener('focus', () => {
    if (!ROOT) return;
    // Auto-focus root if nothing focused yet
    if (!FOCUSED_NODE) { FOCUSED_NODE = ROOT; renderFolderNav(); }
    showDirHint();
  });

  nav.addEventListener('blur', () => {
    // Keep focused state, just hide the hint
    setTimeout(() => document.getElementById('dir-hint').classList.remove('show'), 200);
  });

  nav.addEventListener('keydown', async (e) => {
    if (!ROOT) return;

    const flat = buildFlatList(ROOT, []);
    const idx  = FOCUSED_NODE ? flat.indexOf(FOCUSED_NODE) : -1;

    switch (e.key) {
      // â”€â”€ â†“ Move to next visible node â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      case 'ArrowDown': {
        e.preventDefault();
        if (idx < flat.length - 1) {
          FOCUSED_NODE = flat[idx + 1];
          renderFolderNav();
          scrollFocusedIntoView();
        }
        break;
      }

      // â”€â”€ â†‘ Move to previous visible node â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      case 'ArrowUp': {
        e.preventDefault();
        if (idx > 0) {
          FOCUSED_NODE = flat[idx - 1];
          renderFolderNav();
          scrollFocusedIntoView();
        }
        break;
      }

      // â”€â”€ â†’ Expand focused node (or go into first child) â”€â”€â”€â”€â”€â”€
      case 'ArrowRight': {
        e.preventDefault();
        if (!FOCUSED_NODE) break;
        const node = FOCUSED_NODE;
        const subFolders = node.children.filter(c => c.type === 'folder');

        if (!EXPANDED.has(node)) {
          // Expand it
          EXPANDED.add(node);
          if (!node.loaded) {
            renderFolderNav();
            try { await loadNode(node); updateStats(); } catch(err) { EXPANDED.delete(node); }
          }
          renderFolderNav();
        } else if (subFolders.length > 0) {
          // Already expanded â†’ move into first child
          FOCUSED_NODE = subFolders[0];
          renderFolderNav();
          scrollFocusedIntoView();
        }
        break;
      }

      // â”€â”€ â† Collapse focused node (or go to parent) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      case 'ArrowLeft': {
        e.preventDefault();
        if (!FOCUSED_NODE || FOCUSED_NODE === ROOT) break;
        const node = FOCUSED_NODE;

        if (EXPANDED.has(node)) {
          // Collapse it
          EXPANDED.delete(node);
          renderFolderNav();
        } else {
          // Not expanded â†’ jump to parent
          const parent = findParent(ROOT, node);
          if (parent) {
            FOCUSED_NODE = parent;
            renderFolderNav();
            scrollFocusedIntoView();
          }
        }
        break;
      }

      // â”€â”€ Enter â†’ Navigate to focused folder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      case 'Enter': {
        e.preventDefault();
        if (!FOCUSED_NODE) break;
        if (FOCUSED_NODE === ROOT) { goRoot(); }
        else { drillFolder(FOCUSED_NODE); }
        break;
      }

      // â”€â”€ Escape â†’ Go up to parent folder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      case 'Escape': {
        e.preventDefault();
        if (!FOCUSED_NODE || FOCUSED_NODE === ROOT) break;
        const parent = findParent(ROOT, FOCUSED_NODE);
        if (parent) {
          FOCUSED_NODE = parent;
          renderFolderNav();
          scrollFocusedIntoView();
        }
        break;
      }

      // â”€â”€ Home â†’ Jump to root â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      case 'Home': {
        e.preventDefault();
        FOCUSED_NODE = ROOT;
        renderFolderNav();
        nav.querySelector('.tree-root')?.scrollIntoView({ block:'start' });
        break;
      }

      // â”€â”€ End â†’ Jump to last visible node â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      case 'End': {
        e.preventDefault();
        FOCUSED_NODE = flat[flat.length - 1];
        renderFolderNav();
        scrollFocusedIntoView();
        break;
      }
    }
  });
});

// Walk tree to find parent of a given node
function findParent(root, target) {
  function walk(node) {
    for (const child of node.children) {
      if (child.type !== 'folder') continue;
      if (child === target) return node;
      const found = walk(child);
      if (found) return found;
    }
    return null;
  }
  return walk(root);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIGHTBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function lbOpen(idx) {
  if (idx < 0 || idx >= LB_IMGS.length) return;
  LB_IDX = idx;
  document.getElementById('lb-img').src = LB_IMGS[idx].url;
  document.getElementById('lb-cap').textContent = `${LB_IMGS[idx].name} (${idx+1}/${LB_IMGS.length})`;
  document.getElementById('lb').classList.add('open');
  document.body.style.overflow = 'hidden';
  addHist({ type:'view', name:LB_IMGS[idx].name, url:LB_IMGS[idx].url, ts:Date.now() });
  saveHist(); renderHistPanel();
}

function lbClose() {
  document.getElementById('lb').classList.remove('open');
  document.body.style.overflow = '';
}

function lbNav(dir) {
  LB_IDX = (LB_IDX + dir + LB_IMGS.length) % LB_IMGS.length;
  const img = document.getElementById('lb-img');
  img.style.opacity = '0';
  setTimeout(() => {
    img.src = LB_IMGS[LB_IDX].url;
    img.style.opacity = '1';
    document.getElementById('lb-cap').textContent = `${LB_IMGS[LB_IDX].name} (${LB_IDX+1}/${LB_IMGS.length})`;
  }, 150);
}

// ============================================================================
// HISTORY
// ============================================================================
function loadHist() { try { HIST = JSON.parse(localStorage.getItem('storage_hist')||'[]'); } catch { HIST=[]; } }
function saveHist() { HIST=HIST.slice(0,MAX_HIST); localStorage.setItem('storage_hist',JSON.stringify(HIST)); }
function addHist(e) { HIST.unshift(e); }
function clearHistory() { HIST=[]; saveHist(); renderHistPanel(); renderHistView(); toast('History cleared'); }

function renderHistPanel() {
  const el = document.getElementById('hp-list');
  if (!HIST.length) { el.innerHTML='<div style="padding:20px;text-align:center;color:var(--dim);">No history yet</div>'; return; }
  el.innerHTML = HIST.slice(0,40).map(h => {
    const label = h.type==='view' ? h.name : h.type==='scan' ? 'Scan root' : (h.name || h.folder);
    const ic    = h.type==='view' ? `<img src="${esc(h.url)}" style="width:100%;height:100%;object-fit:cover;" onerror="this.outerHTML='ğŸ–¼ï¸'">` : (h.type==='scan'?'ğŸ”„':'ğŸ“');
    const click = h.type==='view' ? `lbOpen(LB_IMGS.findIndex(f=>f.url==="${esc(h.url)}"))`
                : h.type==='folder' ? `drillByPath('${esc(h.folder)}')` : '';
    return `<div class="hpanel-row" onclick="${click}">
      <div class="hist-th">${ic}</div>
      <div style="flex:1;min-width:0;">
        <p style="font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(label)}</p>
        <p style="font-size:10px;color:var(--dim);">${ago(h.ts)}</p>
      </div>
    </div>`;
  }).join('');
}

function renderHistView() {
  document.getElementById('history-view').style.display = 'block';
  const el = document.getElementById('hv-list');
  if (!HIST.length) { el.innerHTML='<div style="padding:60px;text-align:center;color:var(--dim);">No history yet.</div>'; return; }
  el.innerHTML = HIST.map((h,i) => {
    const color = h.type==='scan'?'#5b6af0':h.type==='folder'?'#f59e0b':'#16a36a';
    const label = h.type==='view' ? h.name : h.type==='scan' ? 'Scanned root' : (h.name || h.folder);
    const click = h.type==='view' ? `lbOpen(LB_IMGS.findIndex(f=>f.url==="${esc(h.url)}"))` :
                  h.type==='folder' ? `drillByPath('${esc(h.folder)}')` : '';
    return `<div class="hist-row fu" style="animation-delay:${Math.min(i*0.03,0.6)}s" onclick="${click}">
      <div class="hist-th">${h.type==='view'?`<img src="${esc(h.url)}" style="width:100%;height:100%;object-fit:cover;" onerror="this.outerHTML='ğŸ–¼ï¸'">`:(h.type==='scan'?'ğŸ”„':'ğŸ“')}</div>
      <div style="flex:1;min-width:0;">
        <p style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(label)}</p>
        <p style="font-size:10px;color:var(--dim);">${ago(h.ts)}</p>
      </div>
      <span class="tag" style="background:${color}22;color:${color}">${h.type.toUpperCase()}</span>
    </div>`;
  }).join('');
}

// ============================================================================
// UI HELPERS
// ============================================================================
function showSec(sec) {
  SEC = sec;
  ['gallery','all','history'].forEach(s => document.getElementById('nav-'+s)?.classList.remove('active'));
  document.getElementById('nav-'+sec)?.classList.add('active');
  hideAll();

  if (sec === 'history') {
    renderHistView();
    bc([{ l:'History' }]);
    return;
  }
  if (!ROOT?.loaded) { showWelcome(); return; }
  setBreadcrumbs(CURRENT_NODE);
  renderCurrent();
}

function setView(v) {
  VIEW = v;
  document.getElementById('btn-grid').classList.toggle('on', v==='grid');
  document.getElementById('btn-list').classList.toggle('on', v==='list');
  renderCurrent();
}

function toggleHistPanel() {
  document.getElementById('hist-panel').classList.toggle('open');
  document.getElementById('main').classList.toggle('hist-open');
}

function bc(crumbs) {
  document.getElementById('bc').innerHTML = crumbs.map((c,i) =>
    `${i ? '<span class="crumb-sep">/</span>' : ''}
     <span class="crumb ${i===crumbs.length-1?'leaf':''}" ${c.action?`onclick="${c.action}"`:''} style="${c.action?'cursor:pointer':''}">${esc(c.l)}</span>`
  ).join('');
}

function hideAll() {
  ['welcome','loading','grid-view','list-view','history-view'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
}

function showWelcome() { hideAll(); document.getElementById('welcome').style.display='flex'; }
function showLoad(msg) { hideAll(); document.getElementById('loading').style.display='flex'; document.getElementById('load-msg').textContent=msg; }

function updateStats() {
  let files=0, imgs=0, vids=0, folders=0, size=0;
  function walk(node) {
    for (const c of node.children) {
      if (c.type==='folder') { folders++; walk(c); }
      else { files++; if(c.kind==='image')imgs++; if(c.kind==='video')vids++; if(c.size)size+=c.size; }
    }
  }
  if (ROOT) walk(ROOT);
  document.getElementById('s-total').textContent = files.toLocaleString();
  document.getElementById('s-img').textContent   = imgs.toLocaleString();
  document.getElementById('s-vid').textContent   = vids.toLocaleString();
  document.getElementById('s-fold').textContent  = folders.toLocaleString();
  document.getElementById('s-size').textContent  = size ? fmtSz(size) : 'â€”';
}

function prog(pct, msg) {
  if (pct != null) { document.getElementById('prog-fill').style.width=pct+'%'; document.getElementById('scan-pct').textContent=Math.round(pct)+'%'; }
  if (msg) document.getElementById('scan-status').textContent = msg;
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3400);
}

function fmtSz(b) {
  if (!b) return 'â€”';
  const u=['B','KB','MB','GB','TB']; let i=0;
  while (b>=1024&&i<u.length-1){b/=1024;i++;}
  return b.toFixed(1)+' '+u[i];
}

function ago(ts) {
  const d = Date.now()-ts;
  if(d<60000)return'just now';
  if(d<3600000)return Math.floor(d/60000)+'m ago';
  if(d<86400000)return Math.floor(d/3600000)+'h ago';
  return Math.floor(d/86400000)+'d ago';
}

function esc(s) {
  return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
}

function fileStyle(ext) {
  const icons={pdf:'ğŸ“„',doc:'ğŸ“',docx:'ğŸ“',xls:'ğŸ“Š',xlsx:'ğŸ“Š',zip:'ğŸ“¦',tar:'ğŸ“¦',rar:'ğŸ“¦',mp3:'ğŸµ',wav:'ğŸµ',txt:'ğŸ“ƒ',js:'ğŸ’»',ts:'ğŸ’»',py:'ğŸ',html:'ğŸŒ',css:'ğŸ¨',json:'ğŸ“‹',sql:'ğŸ—„ï¸',sh:'âš™ï¸'};
  const colors={pdf:'#ef4444',doc:'#5b6af0',docx:'#5b6af0',xls:'#16a24a',xlsx:'#16a24a',zip:'#8b5cf6',mp3:'#e0579a',js:'#d97706',py:'#16a24a',html:'#ea580c',css:'#0284c7',json:'#d97706'};
  const e = (ext||'').toLowerCase();
  return [icons[e]||'ğŸ“„', colors[e]||'#64748b'];
}

// ============================================================================
// HASH ROUTING
// ============================================================================
function pushHash(pathStr) {
  const h = pathStr ? '#p='+encodeURIComponent(pathStr) : '#';
  history.pushState(null, '', h);
}

function readHash() {
  const h = location.hash.slice(1);
  if (!h) return null;
  const params = new URLSearchParams(h);
  return params.get('p') || null;
}

window.addEventListener('popstate', () => {
  const path = readHash();
  if (path) drillByPath(path);
  else goRoot();
});

// ============================================================================
// DRAG & DROP UPLOAD
// ============================================================================
window.addEventListener('dragenter', e => { e.preventDefault(); dragCounter++; if(dragCounter===1)document.getElementById('drop-overlay').classList.add('active'); });
window.addEventListener('dragleave', e => { e.preventDefault(); dragCounter--; if(dragCounter===0)document.getElementById('drop-overlay').classList.remove('active'); });
window.addEventListener('dragover',  e => e.preventDefault());
window.addEventListener('drop', async e => {
  e.preventDefault();
  dragCounter=0;
  document.getElementById('drop-overlay').classList.remove('active');
  const files = e.dataTransfer?.files;
  if (!files?.length || !BASE_URL) return;
  const targetNode = CURRENT_NODE || ROOT;
  const targetUrl  = targetNode.url;
  toast(`Uploading ${files.length} file${files.length>1?'s':''}â€¦`);
  let ok=0;
  for (const file of files) {
    try {
      const res = await fetch(targetUrl+encodeURIComponent(file.name), { method:'PUT', body:file, headers:{'Content-Type':file.type||'application/octet-stream'} });
      if (res.ok) ok++;
    } catch(err){ console.error(err); }
  }
  if (ok) {
    toast(`âœ“ ${ok}/${files.length} uploaded`);
    targetNode.loaded = false;
    await loadNode(targetNode);
    renderCurrent(); updateStats();
  } else {
    toast('âœ— Upload failed â€” check server write permissions');
  }
});

// ============================================================================
// INIT
// ============================================================================
window.addEventListener('DOMContentLoaded', () => {
  loadHist(); renderHistPanel(); renderHistView();
  document.getElementById('server-url').value = 'http://10.10.20.13:6060/tallyapp/v2/';

  document.addEventListener('keydown', e => {
    // Only handle lightbox keys when lightbox is open
    if (document.getElementById('lb').classList.contains('open')) {
      if (e.key==='Escape') lbClose();
      if (e.key==='ArrowLeft') lbNav(-1);
      if (e.key==='ArrowRight') lbNav(1);
    }
  });
  document.getElementById('lb').addEventListener('click', e => { if(e.target===e.currentTarget)lbClose(); });

  startScan();
});
</script>
</body>
</html>